<?php

namespace App\Http\Controllers;

use App\Company;
use App\Employer;
use App\User;
use App\Notifications\newNotification;
use Illuminate\Support\Facades\Storage;
use JD\Cloudder\Facades\Cloudder;
use Validator;
use Illuminate\Http\Request;

class CompaniesController extends Controller
{

    public function index()
    {
        //
    }

    /**
     * @return \Illuminate\Contracts\View\Factory|\Illuminate\View\View
     */
    public function create()
    {
        return view('companies.create');
    }

    /**
     * @param Request $request
     * @return \Illuminate\Http\RedirectResponse|\Illuminate\Routing\Redirector
     */
    public function store(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'name' => 'required|unique:companies|max:255',
            'rotation' => 'required',
            'phone' => 'required',
            'email' => 'required',
            'address' => 'required'
        ]);

        if ($validator->fails()) {
            return redirect('companies/create')
                ->withErrors($validator)
                ->withInput();
        }
        $company = Company::create($request->all());
        if ($request->user()->isAdmin()) {
            $admin = User::where('id', 1)->first();
            \Notification::send($admin, new newNotification("Empresa '$company->name' pendiente validar.", $admin, env('APP_URL') . '/admin'));
            return redirect('admin')->with('status', "¡Creaste una empresa!");
        }
        if ($request->user()->isEmployer()) {
            $employer = User::where('id', $request->user()->id)->first();
            \Notification::send($employer, new newNotification("Tu empresa '$company->name' está pendiente de validar.", $employer, env('APP_URL') . '/company/me'));
            Employer::create([
                'userId' => $request->user()->id,
                'companyId' => $company->id
            ]);
            return redirect('employers')->with('status', "¡Creaste una empresa!");
        }
    }

    /**
     * @param Company $company
     * @return Company
     */
    public function show(Company $company)
    {
        return $company;
    }

    /**
     * @param Company $company
     * @return \Illuminate\Contracts\View\Factory|\Illuminate\View\View
     */
    public function edit(Company $company)
    {
        return view('companies.edit', ['company' => $company]);
    }

    /**
     * @param Request $request
     * @param Company $company
     * @return \Illuminate\Http\RedirectResponse
     */
    public function update(Request $request, Company $company)
    {
        $company = Company::find($company->id);
        $company->approved = $request->approved ? $request->approved : false;
        if ((isset($company->bgPictureUrl) && $request->hasFile('image')) || ($request->hasFile('image'))) {
            $validator = Validator::make($request->all(), [
                'image' => 'required|mimes:jpeg,bmp,jpg,png|between:1,5000'
            ], [
                'between' => 'The :attribute value :input is not between :min - :max.',
                'mimes' => 'The :attribute must be one of the following types: :values',
            ]);
            if ($validator->fails()) {
                return redirect('users/me')
                    ->withErrors($validator)
                    ->withInput();
            }
            $image = $request->file('image')->getRealPath();
            Cloudder::upload($image, null);
            $company->bgPictureUrl = Cloudder::show(Cloudder::getPublicId());
        }
        $company->fill($request->all());
        $company->save();
        return $request->user()->isAdmin() ? redirect('admin')->with('status', "¡Actualizaste a $company->name!") : redirect('company/me')->with('status', "¡Actualizaste a $company->name!");
    }

    public function destroy(Company $company)
    {
        //
    }

    /**
     * @param Request $request
     * @return \Illuminate\Http\JsonResponse
     */
    public function autoComplete(Request $request)
    {
        $subTitles = \DB::table('companies')->where("name", "LIKE", "%{$request->input('query')}%")->pluck('name');
        return response()->json($subTitles);
    }
}
